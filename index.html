<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Chat</title>
  </head>
  <body>
    <h1>WebSocket Chat</h1>
    <div
      id="messages"
      style="
        border: 1px solid #ccc;
        height: 300px;
        overflow-y: scroll;
        padding: 10px;
      "
    ></div>
    <input type="text" id="messageInput" placeholder="Type your message here" />
    <button id="sendButton">Send</button>

    <script>
      // WebSocket 接続先 URL を動的に設定
      const protocol =
        window.location.protocol === "https:" ? "wss://" : "ws://";
      const host = "uutan-deno-websocket-app.deno.dev";
      const port = 443;

      // WebSocket 接続先 URL を構築
      const socketUrl = protocol + host + ":" + port + "/"; // `/` は URL の最後に追加
      console.log(socketUrl);

      // WebSocket の接続を確立
      const socket = new WebSocket(socketUrl);
      const messagesDiv = document.getElementById("messages");
      const messageInput = document.getElementById("messageInput");
      const sendButton = document.getElementById("sendButton");

      // WebSocket が OPEN 状態になった時のみメッセージを送信できるようにする
      socket.onopen = () => {
        console.log("WebSocket is open now.");
      };

      socket.onmessage = (event) => {
        const message = document.createElement("p");
        message.textContent = event.data;
        messagesDiv.appendChild(message);
        messagesDiv.scrollTop = messagesDiv.scrollHeight; // Scroll to the bottom
      };

      sendButton.addEventListener("click", () => {
        if (
          messageInput.value.trim() !== "" &&
          socket.readyState === WebSocket.OPEN
        ) {
          socket.send(messageInput.value);
          messageInput.value = "";
        } else if (socket.readyState !== WebSocket.OPEN) {
          console.log("WebSocket is not open. Please wait until it connects.");
        }
      });

      messageInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          sendButton.click();
        }
      });

      socket.onerror = (error) => {
        console.error("WebSocket error:", error);
      };

      socket.onclose = () => {
        console.log("WebSocket is closed.");
      };
    </script>
  </body>
</html>
